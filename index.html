<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>ãƒ©ãƒãƒ™ãƒ»æ¼«ç”»ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</title>
  <?= include('style'); ?>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ³</h1>

    <div id="login-section" style="text-align: center; margin-top: 50px;">
      <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div id="login-error" style="color: red; margin-bottom: 10px;"></div>
      <form id="login-form">
        <label for="user-id">ID:</label>
        <input type="text" id="user-id" name="id" required><br><br>
        <label for="user-pass">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
        <input type="password" id="user-pass" name="pass" required><br><br>
        <button type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </form>
    </div>
    
    <div id="collection-section" style="display: none;">
      <div style="text-align: right; margin-bottom: 15px;">
        <span id="welcome-message"></span>
        <button onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>

      <div class="tabs">
        <button class="tab-button active" onclick="showTab('lanobe')">ãƒ©ãƒãƒ™ãƒ‡ãƒ¼ã‚¿ (Sheet1)</button>
        <button class="tab-button" onclick="showTab('manga')">æ¼«ç”»ãƒ‡ãƒ¼ã‚¿ (Sheet3)</button>
      </div>

      <div id="lanobe-tab" class="tab-content active">
        <h2>ãƒ©ãƒãƒ™ã‚·ãƒªãƒ¼ã‚ºé€²æ—</h2>
        <p id="lanobe-summary" class="summary"></p>
        <div id="lanobe-list" class="data-list">
          <p class="loading-message">ãƒ©ãƒãƒ™ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>
        </div>
      </div>
      
      <div id="manga-tab" class="tab-content">
        <h2>æ¼«ç”»ã‚·ãƒªãƒ¼ã‚ºé€²æ—</h2>
        <p id="manga-summary" class="summary"></p>
        <div id="manga-list" class="data-list">
          <p class="loading-message">æ¼«ç”»ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------------------------------
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨åˆæœŸè¨­å®š
    // ----------------------------------------------------
    let lanobeData = [];
    let mangaData = [];
    let sessionToken = localStorage.getItem('sessionToken');
    let userId = localStorage.getItem('userId');
    let isAdmin = localStorage.getItem('isAdmin') === 'true';

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('login-form').addEventListener('submit', handleLoginSubmit);
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
        if (sessionToken && userId) {
            handleHeartbeat();
        } else {
            showLogin();
        }
    });

    // ----------------------------------------------------
    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    // ----------------------------------------------------
    function handleLoginSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('user-id').value;
        const pass = document.getElementById('user-pass').value;
        
        // ãƒ­ã‚°ã‚¤ãƒ³APIå‘¼ã³å‡ºã— (doPostã§å‡¦ç†ã•ã‚Œã‚‹)
        const params = { action: 'login', id: id, pass: pass };
        
        // GASã®doPostã¯ç›´æ¥å‘¼ã³å‡ºã›ãªã„ãŸã‚ã€ã“ã“ã§ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®doPostã‚’çµŒç”±ã™ã‚‹
        // ç°¡æ˜“åŒ–ã®ãŸã‚ã€ã“ã“ã§ã¯ç›´æ¥ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°ã‚’å‘¼ã¶ä»£æ›¿ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¾ã™
        
        // â˜…â˜…â˜… èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã®ä»£æ›¿ï¼ˆæœ¬æ¥ã¯doPostã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰ â˜…â˜…â˜…
        // ç°¡æ˜“çš„ã«ç›´æ¥ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆå…¬é–‹ãƒšãƒ¼ã‚¸ã¨ã™ã‚‹ï¼‰ã‹ã€ doPostã«åˆã‚ã›ãŸå®Ÿè£…ãŒå¿…è¦ã§ã™ã€‚
        // ã“ã“ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…ƒã®æ„å›³ã«åˆã‚ã›ã€ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’æ¨¡æ“¬ã—ã€getData()ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
        
        google.script.run
            .withSuccessHandler(onLoginSuccess)
            .withFailureHandler(onLoginFailure)
            .handleLogin(id, pass); // code.gsã®handleLoginã‚’å‘¼ã³å‡ºã™
    }
    
    function onLoginSuccess(response) {
        const errorDiv = document.getElementById('login-error');
        if (response.success) {
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜
            localStorage.setItem('sessionToken', response.token);
            localStorage.setItem('userId', document.getElementById('user-id').value);
            localStorage.setItem('isAdmin', response.isAdmin);
            
            sessionToken = response.token;
            userId = document.getElementById('user-id').value;
            isAdmin = response.isAdmin;
            
            errorDiv.textContent = '';
            showCollection();
            // ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã‚‹ã¨ä»®å®šï¼‰
            onDataLoaded(response.data); 
        } else {
            errorDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + response.message;
        }
    }

    function onLoginFailure(error) {
         document.getElementById('login-error').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
         console.error('Login Error:', error);
    }
    
    // ----------------------------------------------------
    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ¶å¾¡
    // ----------------------------------------------------
    function showLogin() {
        document.getElementById('login-section').style.display = 'block';
        document.getElementById('collection-section').style.display = 'none';
    }
    
    function showCollection() {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('collection-section').style.display = 'block';
        document.getElementById('welcome-message').textContent = `ã‚ˆã†ã“ãã€${userId}ã•ã‚“ã€‚`;
        // ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å†ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
        if (lanobeData.length === 0 && mangaData.length === 0) {
            google.script.run.withSuccessHandler(onDataLoaded).getData();
        }
    }

    // ----------------------------------------------------
    // ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆ / ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    // ----------------------------------------------------
    function handleHeartbeat() {
        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¶­æŒ
        google.script.run
            .withSuccessHandler(response => {
                if (response.status === 'ok') {
                    showCollection();
                } else {
                    handleLogout(true);
                }
            })
            .withFailureHandler(handleLogout)
            .handleHeartbeat(userId, sessionToken);
    }
    
    function handleLogout(noApiCall) {
        localStorage.removeItem('sessionToken');
        localStorage.removeItem('userId');
        localStorage.removeItem('isAdmin');
        sessionToken = null;
        userId = null;
        isAdmin = false;
        
        if (!noApiCall) {
            google.script.run.handleLogout(userId, sessionToken); // ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
        }
        
        showLogin();
    }


    // ----------------------------------------------------
    // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å¾Œã®å‡¦ç† (getData() ã®æˆåŠŸãƒãƒ³ãƒ‰ãƒ©)
    // ----------------------------------------------------
    function onDataLoaded(data) {
      // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ç›´æ¥ãƒ‡ãƒ¼ã‚¿ãŒæ¸¡ã•ã‚ŒãŸå ´åˆã€ã“ã“ã§ã‚»ãƒƒãƒˆ
      if (data.lanobe && data.manga) {
          lanobeData = data.lanobe;
          mangaData = data.manga; // æ¼«ç”»ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
      } else {
          // ãƒ­ã‚°ã‚¤ãƒ³ãŒåˆ¥é€”è¡Œã‚ã‚ŒãŸå¾Œã®getData()å‘¼ã³å‡ºã—ã®å ´åˆ
          lanobeData = data.lanobe;
          mangaData = data.manga;
      }
      
      // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
      renderData('lanobe');
      renderData('manga');
      
      // ãƒ­ãƒ¼ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
      document.querySelectorAll('.loading-message').forEach(el => el.style.display = 'none');
    }

    // ----------------------------------------------------
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
    // ----------------------------------------------------
    function showTab(tabName) {
      const tabs = ['lanobe', 'manga'];
      tabs.forEach(tab => {
        document.getElementById(tab + '-tab').classList.remove('active');
        document.querySelector(`.tab-button[onclick="showTab('${tab}')"]`).classList.remove('active');
      });
      
      document.getElementById(tabName + '-tab').classList.add('active');
      document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
    }

    // ----------------------------------------------------
    // ãƒ‡ãƒ¼ã‚¿æç”»å‡¦ç†
    // ----------------------------------------------------
    function renderData(dataType) {
      const data = (dataType === 'lanobe') ? lanobeData : mangaData;
      const listContainer = document.getElementById(dataType + '-list');
      const summaryElement = document.getElementById(dataType + '-summary');
      listContainer.innerHTML = ''; 
      
      if (data.length < 2) {
        listContainer.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
        summaryElement.innerHTML = `å…¨0ã‚·ãƒªãƒ¼ã‚ºä¸­ã€**0ã‚·ãƒªãƒ¼ã‚ºãŒå®Œçµ**ã—ã¦ã„ã¾ã™ã€‚`;
        return;
      }

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é™¤å¤–
      const header = data[0];
      const bookEntries = data.slice(1);
      
      // ã‚·ãƒªãƒ¼ã‚ºæƒ…å ±ã‚’é›†è¨ˆ
      const seriesMap = processSeries(bookEntries, header);
      
      let html = '';
      let totalSeries = 0;
      let completedSeries = 0;

      for (const [seriesName, info] of seriesMap.entries()) {
        totalSeries++;
        
        // æœ€æ–°å·»ã®æœªè³¼å…¥ãƒ•ãƒ©ã‚°
        const latestBook = info.books.reduce((a, b) => {
            const aVol = parseVolume(a[header.indexOf('ä½œå“å')]);
            const bVol = parseVolume(b[header.indexOf('ä½œå“å')]);
            return bVol > aVol ? b : a;
        });

        const isLatestUnbought = latestBook[header.indexOf('è³¼å…¥æœªè³¼å…¥')] === 'æœªæ‰€æŒ';
        const latestVolume = parseVolume(latestBook[header.indexOf('ä½œå“å')]);
        const status = 'é€£è¼‰ä¸­'; // ç°¡æ˜“è¡¨ç¤º

        html += `
          <div class="series-card ${status === 'é€£è¼‰ä¸­' ? 'ongoing' : 'completed'} ${isLatestUnbought ? 'unbought' : ''}">
            <h3>${seriesName} (${latestVolume === 0 ? 'å¤–ä¼ãªã©' : latestVolume + 'å·»'})</h3>
            <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> ${status}</p>
            <p><strong>æœ€æ–°å·»:</strong> ${latestBook[header.indexOf('ä½œå“å')]}</p>
            <p><strong>è³¼å…¥çŠ¶æ³:</strong> ${isLatestUnbought ? 'æœªè³¼å…¥' : 'è³¼å…¥æ¸ˆ'}</p>
          </div>
        `;
      }

      summaryElement.innerHTML = `å…¨${totalSeries}ã‚·ãƒªãƒ¼ã‚ºä¸­ã€**${completedSeries}ã‚·ãƒªãƒ¼ã‚ºãŒå®Œçµ**ã—ã¦ã„ã¾ã™ã€‚`;
      listContainer.innerHTML = html;
    }

    // ----------------------------------------------------
    // ã‚·ãƒªãƒ¼ã‚ºé›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯
    // ----------------------------------------------------
    function processSeries(bookEntries, header) {
      const titleIndex = header.indexOf('ä½œå“å');
      const seriesMap = new Map();

      bookEntries.forEach(book => {
        const fullTitle = book[titleIndex];
        const seriesInfo = getSeriesNameAndVolume(fullTitle);
        const seriesName = seriesInfo.series;
        
        if (!seriesName) return;

        if (!seriesMap.has(seriesName)) {
          seriesMap.set(seriesName, {
            books: [],
            isCompleted: false
          });
        }
        seriesMap.get(seriesName).books.push(book);
      });

      return seriesMap;
    }

    // ----------------------------------------------------
    // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã‚·ãƒªãƒ¼ã‚ºåã¨å·»æ•°ã‚’æŠ½å‡ºã™ã‚‹ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯
    // ----------------------------------------------------
    function getSeriesNameAndVolume(fullTitle) {
      let title = fullTitle.trim();
      let volume = 0;
      let seriesName = title;
      
      // 1. é’æ˜¥ãƒ–ã‚¿é‡éƒã¯...ã®ç‰¹æ®Šå‡¦ç†
      if (title.startsWith('é’æ˜¥ãƒ–ã‚¿é‡éƒã¯')) {
          // ã€Œé’æ˜¥ãƒ–ã‚¿é‡éƒã¯ã€ã§çµ±ä¸€ã—ã€å·»æ•°ã¯å‰¯é¡Œã‹ã‚‰å–å¾—ã™ã‚‹
          return { series: 'é’æ˜¥ãƒ–ã‚¿é‡éƒã¯', volume: parseVolume(title) };
      }

      // 2. å·»æ•°/ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤ (ã‚·ãƒªãƒ¼ã‚ºåæŠ½å‡ºã®ãŸã‚)
      const volumePatterns = [
        /(\s*[Ff]lag\s*\d+(\.\d+)?[\.\:]?.*)$/, // Flag 1.ã€Flag 4.5ãªã©
        /(\s*#\d+\s*.*)$/, // #01ãªã©
        /(\s*([0-9]+\.[0-9]+))\s*$/, // 4.5, 8.5
        /(\s*ãã®\s*([0-9]+))\s*$/, // ãã®X (çµŒé¨“ã‚¼ãƒ­ãªã©)
        /(\s*(\d+))[\s\-\_\.å·»éƒ¨]?(.*)$/ // 1, 10, 24ãªã©ï¼ˆæœ€ã‚‚ä¸€èˆ¬çš„ãªå·»æ•°ï¼‰
      ];

      for (let pattern of volumePatterns) {
        const match = title.match(pattern);
        if (match) {
          // ã‚·ãƒªãƒ¼ã‚ºåã‹ã‚‰å·»æ•°éƒ¨åˆ†ã¨ãã‚Œã«ç¶šãå‰¯é¡Œã‚’å‰Šé™¤
          seriesName = title.replace(match[0], '').trim();
          break;
        }
      }
      
      // 3. æœ€çµ‚çš„ãªå·»æ•°ã®å–å¾—ï¼ˆè¡¨ç¤ºç”¨ï¼‰
      volume = parseVolume(fullTitle);
      
      // 4. ãã®ä»–ã®ã‚·ãƒªãƒ¼ã‚ºåã®æ­£è¦åŒ–ï¼ˆé•·ã™ãã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ™ãƒ¼ã‚¹åã«ï¼‰
      const baseTitles = [
          'ç¶™æ¯ã®é€£ã‚Œå­ãŒå…ƒã‚«ãƒã ã£ãŸ', 'æ™‚ã€…ãƒœã‚½ãƒƒã¨ãƒ­ã‚·ã‚¢èªã§ãƒ‡ãƒ¬ã‚‹éš£ã®ã‚¢ãƒ¼ãƒªãƒ£ã•ã‚“', 
          'ãŠéš£ã®å¤©ä½¿æ§˜ã«ã„ã¤ã®é–“ã«ã‹é§„ç›®äººé–“ã«ã•ã‚Œã¦ã„ãŸä»¶', 'æ•™ãˆå­ã«è„…è¿«ã•ã‚Œã‚‹ã®ã¯çŠ¯ç½ªã§ã™ã‹?'
      ];
      for (const base of baseTitles) {
          if (seriesName.startsWith(base)) {
              seriesName = base;
              break;
          }
      }
      
      return { series: seriesName.replace(/[^\s\S]*$/, '').trim(), volume: volume };
    }

    // ----------------------------------------------------
    // å·»æ•°ãƒ‘ãƒ¼ã‚¹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (è¡¨ç¤ºç”¨)
    // ----------------------------------------------------
    function parseVolume(title) {
        let volume = 0;
        
        // 1. ç‰¹æ®Šãªå·»åï¼ˆSS, 99.9, ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹, å¤–å…¸ï¼‰ã‚’0ã¨ã—ã¦æ‰±ã†
        if (title.includes('SS') || title.includes('ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹') || title.includes('99.9') || title.includes('å¤–å…¸')) {
             return 0;
        }
        
        // 2. Flag, #, æ™‚é–“ç›®ãªã©ã€æ•°å­—ã‚’å«ã‚€ç‰¹æ®Šãªè¡¨è¨˜
        if (title.includes('Flag') || title.includes('æ™‚é–“ç›®') || title.includes('#')) {
             const numMatch = title.match(/\d+/);
             return numMatch ? parseFloat(numMatch[0]) : 1;
        }
        
        // 3. ä¸€èˆ¬çš„ãªå·»æ•° (X or X.X)
        const volMatch = title.match(/(\d+(\.\d+)?)(?:\s*å·»|$)/);
        if (volMatch) {
            volume = parseFloat(volMatch[1]);
        }
        return volume;
    }

  </script>
</body>
</html>
