<div id="admin-panel" style="display: none;">
        <div class="container">
            <div class="admin-box">
                <h3><i class="fa-solid fa-user-shield"></i> Admin Menu</h3>
                <p>新規ユーザーを自動生成して追加します。</p>
                <button onclick="addNewUser()" id="addUserBtn">
                    <i class="fa-solid fa-plus"></i> Add New User
                </button>
                <div id="admin-result"></div>
            </div>
        </div>
    </div>

<script>
    // ... (既存の定数定義などはそのまま)

    // ページ読み込み時
    window.onload = function() {
        const cachedData = sessionStorage.getItem('libraryData');
        const cachedAdmin = sessionStorage.getItem('isAdmin'); // 管理者フラグ読み込み

        if (cachedData) {
            document.getElementById('login-overlay').style.display = 'none';
            renderLibrary(JSON.parse(cachedData));
            
            // 管理者ならパネルを表示
            if (cachedAdmin === 'true') {
                document.getElementById('admin-panel').style.display = 'block';
            }
        } else {
            document.querySelector('.loading').style.display = 'none';
        }
    };

    // ログイン処理 (修正)
    async function checkPassword() {
        // ... (ID/Pass取得部分は同じ)

        try {
            const response = await fetch(GAS_API_URL, {
                method: 'POST',
                // action: 'login' を明示
                body: JSON.stringify({ action: 'login', id: userId, pass: password })
            });
            const result = await response.json();

            if (result.success) {
                sessionStorage.setItem('libraryData', JSON.stringify(result.data));
                
                // 管理者フラグを保存
                sessionStorage.setItem('isAdmin', result.isAdmin);
                sessionStorage.setItem('authId', userId);     // 再認証用
                sessionStorage.setItem('authPass', password); // 再認証用

                document.getElementById('login-overlay').style.display = 'none';
                
                // 管理者ならパネル表示
                if (result.isAdmin) {
                    document.getElementById('admin-panel').style.display = 'block';
                }

                renderLibrary(result.data);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            // ... (エラー処理)
        }
    }

    // ユーザー追加処理 (新規追加)
    async function addNewUser() {
        const btn = document.getElementById('addUserBtn');
        const resultDiv = document.getElementById('admin-result');
        const myId = sessionStorage.getItem('authId');
        const myPass = sessionStorage.getItem('authPass');

        if (!myId || !myPass) {
            resultDiv.innerHTML = '<span class="error">認証情報が切れています。再ログインしてください。</span>';
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
        resultDiv.innerHTML = '';

        try {
            const response = await fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'add_user',
                    requesterId: myId,
                    requesterPass: myPass
                })
            });
            const res = await response.json();

            if (res.success) {
                resultDiv.innerHTML = `
                    <div class="success-box">
                        <strong>User Created!</strong><br>
                        ID: <code>${res.newUser.id}</code><br>
                        Pass: <code>${res.newUser.pass}</code><br>
                        <span style="font-size:0.8em">※Discordにも通知されました</span>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<span class="error">Error: ${res.message}</span>`;
            }
        } catch (e) {
            resultDiv.innerHTML = `<span class="error">通信エラーが発生しました</span>`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-plus"></i> Add New User';
        }
    }
</script>
