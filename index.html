<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Light Novel Collection</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2><i class="fa-solid fa-lock"></i> Restricted Access</h2>
            <p>認証情報を入力してください</p>
            <input type="text" id="userIdInput" placeholder="User ID">
            <input type="password" id="passwordInput" placeholder="Password">
            <button onclick="performLogin()">Login</button>
            <p id="login-error">エラーメッセージ</p>
        </div>
    </div>

    <header>
        <div class="container">
            <h1><i class="fa-solid fa-book-open"></i> Light Novel Data</h1>
            
            <div class="header-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="検索...">
                </div>
                <button id="logoutBtn" onclick="performLogout()" style="display:none;">
                    <i class="fa-solid fa-right-from-bracket"></i> <span class="mobile-hide">Logout</span>
                </button>
            </div>
        </div>
    </header>

    <div id="admin-panel" style="display: none;">
        <div class="container">
            <div class="admin-box">
                <h3><i class="fa-solid fa-user-shield"></i> Admin Menu</h3>
                <button onclick="addNewUser()" id="addUserBtn">
                    <i class="fa-solid fa-plus"></i> Add New User
                </button>
                <div id="admin-result"></div>
            </div>
        </div>
    </div>

    <main class="container">
        <div id="time-display" style="display:none; text-align:right; font-size:0.8rem; color:#8b949e; margin-bottom:10px;"></div>
        <div id="series-grid" class="grid">
            <div class="loading">Loading...</div>
        </div>
    </main>

    <footer>
        <div class="container"><p>Data provided by GAS</p></div>
    </footer>

    <script>
        // ▼ GAS URLを設定してください ▼
        const GAS_API_URL = "https://script.google.com/macros/s/xxxxxxxxxxxxxxxxx/exec";

        let sessionTimer = null;
        let heartbeatInterval = null;
        const SESSION_LIMIT_MS = 10 * 60 * 1000; // 10分

        window.onload = function() {
            const token = sessionStorage.getItem('token');
            if (token) {
                // セッション復帰
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'inline-block';
                
                const data = JSON.parse(sessionStorage.getItem('libraryData'));
                const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
                
                if (isAdmin) {
                    document.getElementById('admin-panel').style.display = 'block';
                } else {
                    // 管理者以外はタイマー復帰 (本来はログイン時刻を保存すべきだが、リロードでリセット扱いとする)
                    startSessionTimer();
                }
                
                renderLibrary(data);
                startHeartbeat(); // 生存報告開始
            } else {
                document.querySelector('.loading').style.display = 'none';
            }
        };

        async function performLogin() {
            const id = document.getElementById('userIdInput').value;
            const pass = document.getElementById('passwordInput').value;
            const btn = document.querySelector('.login-box button');
            const errorMsg = document.getElementById('login-error');

            if(!id || !pass) return;

            btn.textContent = "Verifying...";
            btn.disabled = true;
            errorMsg.style.display = 'none';

            try {
                const res = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', id: id, pass: pass })
                });
                const result = await res.json();

                if (result.success) {
                    // 保存
                    sessionStorage.setItem('token', result.token);
                    sessionStorage.setItem('userId', id);
                    sessionStorage.setItem('isAdmin', result.isAdmin);
                    sessionStorage.setItem('libraryData', JSON.stringify(result.data));
                    // ユーザー追加用パスワード (管理者のみ)
                    if(result.isAdmin) sessionStorage.setItem('authPass', pass);

                    // UI更新
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('logoutBtn').style.display = 'inline-block';
                    
                    if (result.isAdmin) {
                        document.getElementById('admin-panel').style.display = 'block';
                    } else {
                        startSessionTimer(); // 10分タイマー開始
                    }

                    renderLibrary(result.data);
                    startHeartbeat(); // 生存報告開始

                } else {
                    throw new Error(result.message);
                }
            } catch (e) {
                errorMsg.textContent = e.message;
                errorMsg.style.display = 'block';
            } finally {
                btn.textContent = "Login";
                btn.disabled = false;
            }
        }

        async function performLogout() {
            const id = sessionStorage.getItem('userId');
            const token = sessionStorage.getItem('token');
            
            // サーバーへログアウト通知 (待たなくて良い)
            fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'logout', id: id, token: token })
            });

            // ローカル消去 & リロード
            sessionStorage.clear();
            location.reload();
        }

        // --- 10分タイマー (管理者以外) ---
        function startSessionTimer() {
            const display = document.getElementById('time-display');
            display.style.display = 'block';
            let remaining = SESSION_LIMIT_MS;

            sessionTimer = setInterval(() => {
                remaining -= 1000;
                const min = Math.floor(remaining / 60000);
                const sec = Math.floor((remaining % 60000) / 1000);
                display.textContent = `Session expires in: ${min}:${sec.toString().padStart(2, '0')}`;

                if (remaining <= 0) {
                    clearInterval(sessionTimer);
                    alert("ログイン有効時間(10分)が経過しました。自動ログアウトします。");
                    performLogout();
                }
            }, 1000);
        }

        // --- 生存報告 & BANチェック (30秒ごと) ---
        function startHeartbeat() {
            heartbeatInterval = setInterval(async () => {
                const id = sessionStorage.getItem('userId');
                const token = sessionStorage.getItem('token');
                if (!id || !token) return;

                try {
                    // no-corsだとレスポンス読めないので通常のPOST
                    const res = await fetch(GAS_API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'heartbeat', id: id, token: token })
                    });
                    const result = await res.json();

                    if (result.status === 'banned') {
                        clearInterval(heartbeatInterval);
                        alert("【警告】\n多重ログインが検知されたため、アカウントが24時間停止されました。");
                        sessionStorage.clear();
                        location.reload();
                    } else if (result.status === 'logout') {
                        clearInterval(heartbeatInterval);
                        // セッション切れ (別の場所でログインされた、またはDBから消えた)
                        alert("セッションが無効になりました。ログアウトします。");
                        sessionStorage.clear();
                        location.reload();
                    }
                } catch (e) {
                    console.log("Heartbeat failed", e);
                }
            }, 30000); // 30秒ごと
        }

        // ... (renderLibrary, addNewUser, setupSearch関数は前回と同じなので省略可、またはそのまま記述) ...
        // ※addNewUser関数内の body: JSON.stringify({...}) に requesterId, requesterPass を含めるのを忘れずに
        
        // addNewUserなどの再掲
        async function addNewUser() {
            const btn = document.getElementById('addUserBtn');
            const resultDiv = document.getElementById('admin-result');
            const myId = sessionStorage.getItem('userId');
            const myPass = sessionStorage.getItem('authPass'); // 管理者パスワード

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            
            try {
                const res = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'add_user', requesterId: myId, requesterPass: myPass })
                });
                const r = await res.json();
                if(r.success) {
                    resultDiv.innerHTML = `<div class="success-box">User: ${r.newUser.id}<br>Pass: ${r.newUser.pass}</div>`;
                } else {
                    resultDiv.innerHTML = `<span class="error">${r.message}</span>`;
                }
            } catch(e) {
                resultDiv.innerHTML = "Error";
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-plus"></i> Add New User';
            }
        }
        
        function renderLibrary(data) {
             // ... (前回のrenderLibraryと同じ) ...
             const container = document.getElementById('series-grid');
             container.innerHTML = '';
             setupSearch(data);
             const createCards = (items) => {
                 container.innerHTML = '';
                 if(!items || items.length===0){ container.innerHTML='<p>なし</p>'; return; }
                 items.forEach(series => {
                     // ... カード生成処理 (前回と同じ) ...
                     const total = series.ownedVolumes.length + series.unownedVolumes.length;
                     const percent = total === 0 ? 0 : Math.round((series.ownedVolumes.length / total) * 100);
                     const isComplete = series.unownedVolumes.length === 0 && total > 0;
                     const statusClass = isComplete ? 'status-complete' : 'status-ongoing';
                     const statusText = isComplete ? 'COMPLETED' : `${percent}% COLLECTED`;
                     
                     const card = document.createElement('div');
                     card.className = `card ${statusClass}`;
                     card.innerHTML = `
                        <div class="card-header">
                            <div class="series-title">${series.seriesName}</div>
                            <div class="badge">${statusText}</div>
                        </div>
                        <div class="card-meta">
                            <span><i class="fa-solid fa-user-pen"></i> ${series.author}</span>
                            <span><i class="fa-solid fa-tag"></i> ${series.label}</span>
                        </div>
                        <div class="progress-bar-container"><div class="progress-bar" style="width: ${percent}%"></div></div>
                        <div class="volumes-section">
                            <div class="vol-group owned">
                                <h3>所持 (${series.ownedVolumes.length})</h3>
                                <ul>${series.ownedVolumes.map(v => `<li title="${v.code}">${v.title.replace(series.seriesName,'').trim()||v.title}</li>`).join('')}</ul>
                            </div>
                            <div class="vol-group unowned">
                                <h3>未所持 (${series.unownedVolumes.length})</h3>
                                <ul>${series.unownedVolumes.length===0?'<li class="none">なし</li>':series.unownedVolumes.map(v => `<li title="${v.code}">${v.title.replace(series.seriesName,'').trim()||v.title}</li>`).join('')}</ul>
                            </div>
                        </div>`;
                     container.appendChild(card);
                 });
             };
             createCards(data);
             
             // Search Setup
             const searchInput = document.getElementById('searchInput');
             const newInput = searchInput.cloneNode(true);
             searchInput.parentNode.replaceChild(newInput, searchInput);
             newInput.addEventListener('input', (e) => {
                 const term = e.target.value.toLowerCase();
                 createCards(data.filter(i => i.seriesName.toLowerCase().includes(term) || i.author.toLowerCase().includes(term)));
             });
        }
        function setupSearch(d){}
    </script>
</body>
</html>
