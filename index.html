<!DOCTYPE html>
<html lang="ja">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Light Novel Collection</title>
    <?= include('style'); ?>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2><i class="fa-solid fa-lock"></i> Restricted Access</h2>
            <p>認証情報を入力してください</p>
            <input type="text" id="userIdInput" placeholder="User ID">
            <input type="password" id="passwordInput" placeholder="Password">
            <button onclick="performLogin()">Login</button>
            <p id="login-error" style="display:none;">エラーメッセージ</p>
        </div>
    </div>

    <header>
        <div class="container">
            <h1><i class="fa-solid fa-book-open"></i> Light Novel Data</h1>
            
            <div class="header-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="検索..." oninput="setupSearch()">
                </div>
                <button id="logoutBtn" onclick="performLogout()" style="display:none;">
                    <i class="fa-solid fa-right-from-bracket"></i> <span class="mobile-hide">Logout</span>
                </button>
            </div>
        </div>
    </header>

    <div id="admin-panel" style="display: none;">
        <div class="container">
            <div class="admin-box">
                <h3><i class="fa-solid fa-user-shield"></i> Admin Menu</h3>
                <button onclick="addNewUser()" id="addUserBtn">
                    <i class="fa-solid fa-plus"></i> Add New User
                </button>
                <div id="admin-result"></div>
            </div>
        </div>
    </div>

    <main class="container">
        <div id="time-display" style="display:none; text-align:right; font-size:0.8rem; color:#8b949e; margin-bottom:10px;"></div>
        
        <div id="tab-controls" style="display: none; border-bottom: 1px solid var(--border-color); margin-bottom: 20px;">
            <button class="tab-button active" onclick="switchTab('lanobe')">ラノベデータ</button>
            <button class="tab-button" onclick="switchTab('manga')">漫画データ</button>
        </div>

        <div id="series-grid-lanobe" class="grid active-grid">
            <div class="loading">Loading...</div>
        </div>
        <div id="series-grid-manga" class="grid" style="display: none;">
            <div class="loading">Loading...</div>
        </div>
        
    </main>

    <footer>
        <div class="container"><p>Data provided by GAS</p></div>
    </footer>

    <script>
        const GAS_API_URL = "<?= ScriptApp.getService().getUrl() ?>"; // GAS URLを自動取得
        
        let sessionTimer = null;
        let heartbeatInterval = null;
        const SESSION_LIMIT_MS = 10 * 60 * 1000; // 10分
        let currentData = { lanobe: [], manga: [] }; // データを格納するオブジェクト
        let currentView = 'lanobe'; // 現在表示中のタブ

        window.onload = function() {
            const token = sessionStorage.getItem('token');
            const userId = sessionStorage.getItem('userId');
            
            if (token && userId) {
                // セッション復帰
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'inline-block';
                document.getElementById('tab-controls').style.display = 'flex';
                
                const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
                if (isAdmin) {
                    document.getElementById('admin-panel').style.display = 'block';
                } else {
                    startSessionTimer();
                }
                
                // データロードとハートビート
                loadInitialData(); 
                startHeartbeat(); 
            } else {
                document.querySelector('.loading').style.display = 'none';
            }
            
            // 検索ボックスのイベントリスナーを初期設定（データがロードされたら再設定される）
            document.getElementById('searchInput').addEventListener('input', setupSearch);
        };

        async function loadInitialData() {
            try {
                // GASのgetData関数を呼び出して全データ（ラノベ、漫画）を取得
                const data = await google.script.run.withFailureHandler(console.error).getData();
                if (data && data.lanobe) {
                    currentData = data;
                    renderLibrary(currentData);
                } else {
                    throw new Error("データの取得に失敗しました。");
                }
            } catch (e) {
                console.error("初期データロードエラー:", e);
                document.querySelector('.loading').textContent = 'データエラー';
            }
        }


        // ----------------------------------------------------
        // ログイン・ログアウト・ハートビート (元のリポジトリのAPI呼び出し方式に合わせた)
        // ----------------------------------------------------

        async function performLogin() {
            const id = document.getElementById('userIdInput').value;
            const pass = document.getElementById('passwordInput').value;
            const btn = document.querySelector('.login-box button');
            const errorMsg = document.getElementById('login-error');

            if(!id || !pass) return;

            btn.textContent = "Verifying...";
            btn.disabled = true;
            errorMsg.style.display = 'none';

            try {
                const res = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', id: id, pass: pass })
                });
                const result = await res.json();

                if (result.success) {
                    // 保存
                    sessionStorage.setItem('token', result.token);
                    sessionStorage.setItem('userId', id);
                    sessionStorage.setItem('isAdmin', result.isAdmin);
                    
                    // ログイン成功時、データは doGET ではなく doPost から取得される
                    sessionStorage.setItem('libraryData', JSON.stringify(result.data));
                    if(result.isAdmin) sessionStorage.setItem('authPass', pass);

                    // UI更新
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('logoutBtn').style.display = 'inline-block';
                    document.getElementById('tab-controls').style.display = 'flex';
                    
                    if (result.isAdmin) {
                        document.getElementById('admin-panel').style.display = 'block';
                    } else {
                        startSessionTimer(); // 10分タイマー開始
                    }

                    // ログイン時のデータをレンダリング
                    renderLibrary(result.data);
                    startHeartbeat(); 

                } else {
                    throw new Error(result.message);
                }
            } catch (e) {
                errorMsg.textContent = e.message;
                errorMsg.style.display = 'block';
            } finally {
                btn.textContent = "Login";
                btn.disabled = false;
            }
        }

        async function performLogout() {
            const id = sessionStorage.getItem('userId');
            const token = sessionStorage.getItem('token');
            
            clearInterval(sessionTimer);
            clearInterval(heartbeatInterval);

            // サーバーへログアウト通知 (待たなくて良い)
            fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'logout', id: id, token: token })
            });

            sessionStorage.clear();
            location.reload();
        }

        function startSessionTimer() {
            const display = document.getElementById('time-display');
            display.style.display = 'block';
            let remaining = SESSION_LIMIT_MS;

            sessionTimer = setInterval(() => {
                remaining -= 1000;
                const min = Math.floor(remaining / 60000);
                const sec = Math.floor((remaining % 60000) / 1000);
                display.textContent = `Session expires in: ${min}:${sec.toString().padStart(2, '0')}`;

                if (remaining <= 0) {
                    clearInterval(sessionTimer);
                    alert("ログイン有効時間(10分)が経過しました。自動ログアウトします。");
                    performLogout();
                }
            }, 1000);
        }

        function startHeartbeat() {
            heartbeatInterval = setInterval(async () => {
                const id = sessionStorage.getItem('userId');
                const token = sessionStorage.getItem('token');
                if (!id || !token) return;

                try {
                    const res = await fetch(GAS_API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'heartbeat', id: id, token: token })
                    });
                    const result = await res.json();

                    if (result.status === 'banned' || result.status === 'logout') {
                        clearInterval(heartbeatInterval);
                        alert(result.status === 'banned' ? "【警告】\nアカウントが停止されました。" : "セッションが無効になりました。");
                        sessionStorage.clear();
                        location.reload();
                    }
                } catch (e) {
                    console.log("Heartbeat failed", e);
                }
            }, 30000); 
        }

        // ----------------------------------------------------
        // UI & データ処理
        // ----------------------------------------------------

        function switchTab(target) {
            currentView = target;
            const grids = { lanobe: document.getElementById('series-grid-lanobe'), manga: document.getElementById('series-grid-manga') };
            const buttons = document.querySelectorAll('.tab-button');
            
            for (const key in grids) {
                grids[key].style.display = key === target ? 'grid' : 'none';
            }
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('onclick').includes(target));
            });
            
            // タブ切り替え時に検索を再適用
            setupSearch();
        }

        function renderLibrary(data) {
            // data.lanobeとdata.mangaが存在しない場合を考慮し、セッションストレージから復元
            const lanobeData = data.lanobe || JSON.parse(sessionStorage.getItem('libraryData')).lanobe || [];
            const mangaData = data.manga || JSON.parse(sessionStorage.getItem('libraryData')).manga || [];
            
            renderGrid('lanobe', lanobeData);
            renderGrid('manga', mangaData);
            
            // 検索セットアップを再実行
            setupSearch(); 
        }
        
        function renderGrid(dataType, seriesList) {
            const container = document.getElementById(`series-grid-${dataType}`);
            container.innerHTML = '';
            
            if (!seriesList || seriesList.length === 0) {
                container.innerHTML = '<p>データがありません。</p>';
                return;
            }
            
            seriesList.forEach(series => {
                const total = series.ownedVolumes.length + series.unownedVolumes.length;
                const percent = total === 0 ? 0 : Math.round((series.ownedVolumes.length / total) * 100);
                const isComplete = series.unownedVolumes.length === 0 && total > 0;
                const statusClass = isComplete ? 'status-complete' : 'status-ongoing';
                const statusText = isComplete ? 'COMPLETED' : `${percent}% COLLECTED`;
                
                const card = document.createElement('div');
                card.className = `card ${statusClass}`;
                card.innerHTML = `
                    <div class="card-header">
                        <div class="series-title">${series.seriesName}</div>
                        <div class="badge">${statusText}</div>
                    </div>
                    <div class="card-meta">
                        <span><i class="fa-solid fa-user-pen"></i> ${series.author}</span>
                        <span><i class="fa-solid fa-tag"></i> ${series.label}</span>
                    </div>
                    <div class="progress-bar-container"><div class="progress-bar" style="width: ${percent}%"></div></div>
                    <div class="volumes-section">
                        <div class="vol-group owned">
                            <h3>所持 (${series.ownedVolumes.length})</h3>
                            <ul>${series.ownedVolumes.map(v => `<li title="${v.code}">${v.title.replace(series.seriesName,'').trim()||v.title}</li>`).join('')}</ul>
                        </div>
                        <div class="vol-group unowned">
                            <h3>未所持 (${series.unownedVolumes.length})</h3>
                            <ul>${series.unownedVolumes.length===0?'<li class="none">なし</li>':series.unownedVolumes.map(v => `<li title="${v.code}">${v.title.replace(series.seriesName,'').trim()||v.title}</li>`).join('')}</ul>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
        }
        
        // ----------------------------------------------------
        // 検索ロジック
        // ----------------------------------------------------
        let libraryDataCache = {};
        
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const term = searchInput.value.toLowerCase();
            
            // 初回実行時にデータセットアップ
            if (Object.keys(libraryDataCache).length === 0) {
                const data = JSON.parse(sessionStorage.getItem('libraryData'));
                if (data) {
                    libraryDataCache = data;
                } else {
                    return;
                }
            }

            const dataToSearch = (currentView === 'lanobe') ? libraryDataCache.lanobe : libraryDataCache.manga;
            const targetGridId = `series-grid-${currentView}`;
            const container = document.getElementById(targetGridId);
            
            // 検索フィルター
            const filteredData = dataToSearch.filter(series => 
                series.seriesName.toLowerCase().includes(term) || 
                series.author.toLowerCase().includes(term) ||
                series.label.toLowerCase().includes(term)
            );

            // 検索結果のレンダリング
            container.innerHTML = '';
            if (filteredData.length === 0) {
                container.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-sub);">「${term}」に一致するシリーズは見つかりませんでした。</p>`;
            } else {
                renderGrid(currentView, filteredData);
            }
        }
        
        // ----------------------------------------------------
        // Admin Tool (仮)
        // ----------------------------------------------------
        async function addNewUser() {
            const btn = document.getElementById('addUserBtn');
            const resultDiv = document.getElementById('admin-result');
            const myId = sessionStorage.getItem('userId');
            const myPass = sessionStorage.getItem('authPass'); 

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            
            try {
                const res = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'add_user', requesterId: myId, requesterPass: myPass })
                });
                const r = await res.json();
                if(r.success) {
                    resultDiv.innerHTML = `<div class="success-box">User: ${r.newUser.id}<br>Pass: ${r.newUser.pass}</div>`;
                } else {
                    resultDiv.innerHTML = `<span class="error">${r.message}</span>`;
                }
            } catch(e) {
                resultDiv.innerHTML = "Error";
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-plus"></i> Add New User';
            }
        }
    </script>
</body>
</html>
