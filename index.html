<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>ãƒ©ãƒãƒ™ãƒ»æ¼«ç”»ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</title>
  <?= include('style'); ?>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ³</h1>

    <div id="login-section">
      <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div id="login-error" class="error-message"></div>
      <form id="login-form">
        <div class="form-group">
            <label for="user-id">ID:</label>
            <input type="text" id="user-id" name="id" required>
        </div>
        <div class="form-group">
            <label for="user-pass">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
            <input type="password" id="user-pass" name="pass" required>
        </div>
        <button type="submit" class="submit-button">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </form>
    </div>
    
    <div id="collection-section" style="display: none;">
      <div class="header-controls">
        <span id="welcome-message"></span>
        <button onclick="handleLogout()" class="logout-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>

      <div class="tabs">
        <button class="tab-button active" onclick="showTab('lanobe')">ãƒ©ãƒãƒ™ãƒ‡ãƒ¼ã‚¿ (Sheet1)</button>
        <button class="tab-button" onclick="showTab('manga')">æ¼«ç”»ãƒ‡ãƒ¼ã‚¿ (Sheet3)</button>
      </div>

      <div id="lanobe-tab" class="tab-content active">
        <h2>ãƒ©ãƒãƒ™ã‚·ãƒªãƒ¼ã‚ºé€²æ—</h2>
        <p id="lanobe-summary" class="summary"></p>
        <div id="lanobe-list" class="data-list">
          <p class="loading-message">ãƒ©ãƒãƒ™ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>
        </div>
      </div>
      
      <div id="manga-tab" class="tab-content">
        <h2>æ¼«ç”»ã‚·ãƒªãƒ¼ã‚ºé€²æ—</h2>
        <p id="manga-summary" class="summary"></p>
        <div id="manga-list" class="data-list">
          <p class="loading-message">æ¼«ç”»ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------------------------------
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨åˆæœŸè¨­å®š
    // ----------------------------------------------------
    let lanobeData = [];
    let mangaData = [];
    let sessionToken = localStorage.getItem('sessionToken');
    let userId = localStorage.getItem('userId');
    let isAdmin = localStorage.getItem('isAdmin') === 'true';

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('login-form').addEventListener('submit', handleLoginSubmit);
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
        if (sessionToken && userId) {
            handleHeartbeat();
        } else {
            showLogin();
        }
    });

    // ----------------------------------------------------
    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    // ----------------------------------------------------
    function handleLoginSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('user-id').value;
        const pass = document.getElementById('user-pass').value;
        
        document.getElementById('login-error').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
        
        google.script.run
            .withSuccessHandler(onLoginSuccess)
            .withFailureHandler(onLoginFailure)
            .handleLogin(id, pass);
    }
    
    function onLoginSuccess(response) {
        const errorDiv = document.getElementById('login-error');
        if (response.success) {
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜
            localStorage.setItem('sessionToken', response.token);
            localStorage.setItem('userId', document.getElementById('user-id').value);
            localStorage.setItem('isAdmin', response.isAdmin);
            
            sessionToken = response.token;
            userId = document.getElementById('user-id').value;
            isAdmin = response.isAdmin;
            
            errorDiv.textContent = '';
            showCollection();
            
            // ãƒ‡ãƒ¼ã‚¿å–å¾—
            google.script.run.withSuccessHandler(onDataLoaded).getData();
        } else {
            errorDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + response.message;
        }
    }

    function onLoginFailure(error) {
         document.getElementById('login-error').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
         console.error('Login Error:', error);
    }
    
    // ----------------------------------------------------
    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ¶å¾¡
    // ----------------------------------------------------
    function showLogin() {
        document.getElementById('login-section').style.display = 'block';
        document.getElementById('collection-section').style.display = 'none';
        document.getElementById('login-error').textContent = '';
    }
    
    function showCollection() {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('collection-section').style.display = 'block';
        document.getElementById('welcome-message').textContent = `ã‚ˆã†ã“ãã€${userId}ã•ã‚“ã€‚`;
    }

    // ----------------------------------------------------
    // ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆ / ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    // ----------------------------------------------------
    function handleHeartbeat() {
        google.script.run
            .withSuccessHandler(response => {
                if (response.status === 'ok') {
                    showCollection();
                    // ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
                    if (lanobeData.length === 0 && mangaData.length === 0) {
                        google.script.run.withSuccessHandler(onDataLoaded).getData();
                    }
                } else {
                    handleLogout(true); // ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œ
                }
            })
            .withFailureHandler(handleLogout)
            .handleHeartbeat(userId, sessionToken);
    }
    
    function handleLogout(noApiCall) {
        if (!noApiCall) {
            google.script.run.handleLogout(userId, sessionToken); // ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
        }
        
        localStorage.removeItem('sessionToken');
        localStorage.removeItem('userId');
        localStorage.removeItem('isAdmin');
        sessionToken = null;
        userId = null;
        isAdmin = false;
        
        showLogin();
    }


    // ----------------------------------------------------
    // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å¾Œã®å‡¦ç† (getData() ã®æˆåŠŸãƒãƒ³ãƒ‰ãƒ©)
    // ----------------------------------------------------
    function onDataLoaded(data) {
      lanobeData = data.lanobe;
      mangaData = data.manga; 
      
      renderData('lanobe');
      renderData('manga');
      
      document.querySelectorAll('.loading-message').forEach(el => el.style.display = 'none');
    }

    // ----------------------------------------------------
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
    // ----------------------------------------------------
    function showTab(tabName) {
      const tabs = ['lanobe', 'manga'];
      tabs.forEach(tab => {
        document.getElementById(tab + '-tab').classList.remove('active');
        document.querySelector(`.tab-button[onclick="showTab('${tab}')"]`).classList.remove('active');
      });
      
      document.getElementById(tabName + '-tab').classList.add('active');
      document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
    }

    // ----------------------------------------------------
    // ãƒ‡ãƒ¼ã‚¿æç”»å‡¦ç†
    // ----------------------------------------------------
    function renderData(dataType) {
      const data = (dataType === 'lanobe') ? lanobeData : mangaData;
      const listContainer = document.getElementById(dataType + '-list');
      const summaryElement = document.getElementById(dataType + '-summary');
      listContainer.innerHTML = ''; 
      
      if (data.length < 2) {
        listContainer.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
        summaryElement.innerHTML = `å…¨0ã‚·ãƒªãƒ¼ã‚ºä¸­ã€**0ã‚·ãƒªãƒ¼ã‚ºãŒå®Œçµ**ã—ã¦ã„ã¾ã™ã€‚`;
        return;
      }

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é™¤å¤–
      const header = data[0];
      const bookEntries = data.slice(1);
      
      const seriesMap = processSeries(bookEntries, header);
      
      let html = '';
      let totalSeries = 0;
      let completedSeries = 0;

      for (const [seriesName, info] of seriesMap.entries()) {
        totalSeries++;
        
        const titleIndex = header.indexOf('ä½œå“å');
        const purchaseIndex = header.indexOf('è³¼å…¥æœªè³¼å…¥');
        
        // æœ€æ–°å·»ã®ç‰¹å®š
        const latestBook = info.books.reduce((a, b) => {
            const aVol = parseVolume(a[titleIndex]);
            const bVol = parseVolume(b[titleIndex]);
            return bVol > aVol ? b : a;
        });

        const isLatestUnbought = latestBook[purchaseIndex] === 'æœªæ‰€æŒ';
        const latestVolume = parseVolume(latestBook[titleIndex]);
        const status = 'é€£è¼‰ä¸­'; // ç°¡æ˜“è¡¨ç¤º

        html += `
          <div class="series-card ${status === 'é€£è¼‰ä¸­' ? 'ongoing' : 'completed'} ${isLatestUnbought ? 'unbought' : ''}">
            <h3>${seriesName} (${latestVolume === 0 ? 'å¤–ä¼ãªã©' : latestVolume + 'å·»'})</h3>
            <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> ${status}</p>
            <p><strong>æœ€æ–°å·»:</strong> ${latestBook[titleIndex]}</p>
            <p><strong>è³¼å…¥çŠ¶æ³:</strong> ${isLatestUnbought ? 'æœªè³¼å…¥' : 'è³¼å…¥æ¸ˆ'}</p>
          </div>
        `;
      }

      summaryElement.innerHTML = `å…¨${totalSeries}ã‚·ãƒªãƒ¼ã‚ºä¸­ã€**${completedSeries}ã‚·ãƒªãƒ¼ã‚ºãŒå®Œçµ**ã—ã¦ã„ã¾ã™ã€‚`;
      listContainer.innerHTML = html;
    }

    // ----------------------------------------------------
    // ã‚·ãƒªãƒ¼ã‚ºé›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯
    // ----------------------------------------------------
    function processSeries(bookEntries, header) {
      const titleIndex = header.indexOf('ä½œå“å');
      const seriesMap = new Map();

      bookEntries.forEach(book => {
        const fullTitle = book[titleIndex];
        const seriesInfo = getSeriesNameAndVolume(fullTitle);
        const seriesName = seriesInfo.series;
        
        if (!seriesName) return;

        if (!seriesMap.has(seriesName)) {
          seriesMap.set(seriesName, {
            books: [],
            isCompleted: false
          });
        }
        seriesMap.get(seriesName).books.push(book);
      });

      return seriesMap;
    }

    // ----------------------------------------------------
    // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã‚·ãƒªãƒ¼ã‚ºåã¨å·»æ•°ã‚’æŠ½å‡ºã™ã‚‹ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯
    // ----------------------------------------------------
    function getSeriesNameAndVolume(fullTitle) {
      let title = fullTitle.trim();
      let volume = 0;
      let seriesName = title;
      
      // 1. é’æ˜¥ãƒ–ã‚¿é‡éƒã¯...ã®ç‰¹æ®Šå‡¦ç†
      if (title.startsWith('é’æ˜¥ãƒ–ã‚¿é‡éƒã¯')) {
          return { series: 'é’æ˜¥ãƒ–ã‚¿é‡éƒã¯', volume: parseVolume(title) };
      }

      // 2. å·»æ•°/ãƒŠãƒ³ãƒãƒªãƒ³ã‚°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤ (ã‚·ãƒªãƒ¼ã‚ºåæŠ½å‡ºã®ãŸã‚)
      const volumePatterns = [
        /(\s*[Ff]lag\s*\d+(\.\d+)?[\.\:]?.*)$/, 
        /(\s*#\d+\s*.*)$/, 
        /(\s*([0-9]+\.[0-9]+))\s*$/, 
        /(\s*ãã®\s*([0-9]+))\s*$/, 
        /(\s*(\d+))[\s\-\_\.å·»éƒ¨]?(.*)$/ 
      ];

      for (let pattern of volumePatterns) {
        const match = title.match(pattern);
        if (match) {
          seriesName = title.replace(match[0], '').trim();
          break;
        }
      }
      
      // 3. æœ€çµ‚çš„ãªå·»æ•°ã®å–å¾—ï¼ˆè¡¨ç¤ºç”¨ï¼‰
      volume = parseVolume(fullTitle);
      
      // 4. ãã®ä»–ã®ã‚·ãƒªãƒ¼ã‚ºåã®æ­£è¦åŒ–
      const baseTitles = [
          'ç¶™æ¯ã®é€£ã‚Œå­ãŒå…ƒã‚«ãƒã ã£ãŸ', 'æ™‚ã€…ãƒœã‚½ãƒƒã¨ãƒ­ã‚·ã‚¢èªã§ãƒ‡ãƒ¬ã‚‹éš£ã®ã‚¢ãƒ¼ãƒªãƒ£ã•ã‚“', 
          'ãŠéš£ã®å¤©ä½¿æ§˜ã«ã„ã¤ã®é–“ã«ã‹é§„ç›®äººé–“ã«ã•ã‚Œã¦ã„ãŸä»¶', 'æ•™ãˆå­ã«è„…è¿«ã•ã‚Œã‚‹ã®ã¯çŠ¯ç½ªã§ã™ã‹?'
      ];
      for (const base of baseTitles) {
          if (seriesName.startsWith(base)) {
              seriesName = base;
              break;
          }
      }
      
      return { series: seriesName.replace(/[^\s\S]*$/, '').trim(), volume: volume };
    }

    // ----------------------------------------------------
    // å·»æ•°ãƒ‘ãƒ¼ã‚¹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (è¡¨ç¤ºç”¨)
    // ----------------------------------------------------
    function parseVolume(title) {
        let volume = 0;
        
        if (title.includes('SS') || title.includes('ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹') || title.includes('99.9') || title.includes('å¤–å…¸')) {
             return 0;
        }
        
        if (title.includes('Flag') || title.includes('æ™‚é–“ç›®') || title.includes('#')) {
             const numMatch = title.match(/\d+/);
             return numMatch ? parseFloat(numMatch[0]) : 1;
        }
        
        const volMatch = title.match(/(\d+(\.\d+)?)(?:\s*å·»|$)/);
        if (volMatch) {
            volume = parseFloat(volMatch[1]);
        }
        return volume;
    }

  </script>
</body>
</html>
